// @flow
;(function(root, factory) {
  if (typeof root.define === 'function' && root.define.amd) root.define(factory);
  else if (typeof exports === 'object') factory(true);
   // $FlowFixMe
  else root.flume = factory();
})(this, function(cjs) {
  type InputDef = {
    defType: 'input'
  };

  type TransformDef = {
    parents: Defs,
    defType: 'transform',
    init: TransformInitFn,
    transform: TransformFn
  };

  type Def = InputDef | TransformDef;

  type Defs = Def | Def[];

  type TransformFn = (state: any, value: any, {
    source: Def,
    parent: Def,
    dispatch: DispatchFn
  }) => any;

  type TransformInitFn = () => any;

  type DispatchFn = (src: InputDef, value: any, done: () => any) => any;

  type HandleFn = (
    msg: Msg[],
    parent: InputDef | null,
    source?: InputDef,
    end?: () => any,
  ) => void;

  type Msg = {
    type: string,
    value: any
  };

  type Graph = null;

  type Node = {
    graph: Graph,
    def: Def,
    child: Node | null,
    index: number,
    handler: HandleFn
  };

  function noop() {
  }

  function input() : InputDef {
    return {defType: 'input'};
  }

  function transform(transformFn: TransformFn, transformInitFn: ?TransformInitFn) : function {
    return function transformFn(parents: Defs) : TransformDef {
      return {
        parents: parents,
        defType: 'transform',
        init: transformInitFn || noop,
        transform: transformFn
      };
    };
  }
});
